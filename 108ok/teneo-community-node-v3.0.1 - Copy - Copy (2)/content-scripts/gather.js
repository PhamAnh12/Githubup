var gather=function(){"use strict";var St=Object.defineProperty;var Ct=(v,g,D)=>g in v?St(v,g,{enumerable:!0,configurable:!0,writable:!0,value:D}):v[g]=D;var u=(v,g,D)=>Ct(v,typeof g!="symbol"?g+"":g,D);var j,X;const v={version:"1.0.0",generalConfig:{passiveGatheringEnabled:!0,contentExtractionEnabled:!0,maxCaptures:50,xEnabled:{active:!0,passive:!0},redditEnabled:{active:!0,passive:!0}},xPlatformConfig:{id:"x",name:"x/X",version:"1.0.0",hostnames:["x.com","x.com","pro.x.com","www.x.com","www.x.com"],capabilities:{active:!0,passive:!0},paths:["/","/home","/explore","/i/bookmarks","/:username","/:username/status/:tweetId"],gathering:{active:{commands:[],apiInterception:{patterns:["Timeline","HomeTimeline","SearchTimeline","UserByScreenName","UserByRestId","UsersByRestIds","TweetDetail","UserTweets","UserTweetsAndReplies","HomeLatestTimeline","ListLatestTweetsTimeline","TweetResultByRestId","Likes","Following","Followers"],extractors:[{id:"x-any-timeline",mappingConfigId:"x-post",type:"post",responsePaths:["data.home.home_timeline_urt.instructions","data.user.result.timeline.timeline.instructions","data.search_by_raw_query.search_timeline.timeline.instructions","data.threaded_conversation_with_injections_v2.instructions"],entryExtraction:{path:"entries",filters:[{field:"content.entryType",values:["TimelineTimelineItem"]}]},dataMapping:{id:"content.itemContent.tweet_results.result.rest_id",content:"content.itemContent.tweet_results.result.legacy.full_text",timestamp:"content.itemContent.tweet_results.result.legacy.created_at",url:{template:"https://x.com/{author.username}/status/{id}",params:{"author.username":"content.itemContent.tweet_results.result.core.user_results.result.legacy.screen_name",id:"content.itemContent.tweet_results.result.rest_id"}},"interactions.likes":{path:"content.itemContent.tweet_results.result.legacy.favorite_count",transform:"toNumber"},"interactions.retweets":{path:"content.itemContent.tweet_results.result.legacy.retweet_count",transform:"toNumber"},"interactions.replies":{path:"content.itemContent.tweet_results.result.legacy.reply_count",transform:"toNumber"},"author.name":{path:"content.itemContent.tweet_results.result.core.user_results.result.legacy.name"},"author.username":{path:"content.itemContent.tweet_results.result.core.user_results.result.legacy.screen_name"},"author.imageUrl":{path:"content.itemContent.tweet_results.result.core.user_results.result.legacy.profile_image_url_https"},"author.profileUrl":{template:"https://x.com/{username}",params:{username:"content.itemContent.tweet_results.result.core.user_results.result.legacy.screen_name"}},mediaUrls:{path:"content.itemContent.tweet_results.result.legacy.entities.media",transform:"arrayMap",mapping:{field:"media_url_https"}}}},{id:"x-user-by-id",mappingConfigId:"x-profile",type:"profile",responsePaths:["data.user.result","data.user_result.result","data.user_by_screen_name.result","data.user_by_rest_id.result"],entryExtraction:{path:"",filters:[]},dataMapping:{id:"rest_id",bio:"legacy.description",displayName:"legacy.name",username:"legacy.screen_name",profileImage:"legacy.profile_image_url_https",followerCount:{path:"legacy.followers_count",transform:"toNumber"},followingCount:{path:"legacy.friends_count",transform:"toNumber"},verified:"legacy.verified",location:"legacy.location",website:"legacy.url",joinDate:"legacy.created_at",postCount:{path:"legacy.statuses_count",transform:"toNumber"}},validation:{required:["id","username","displayName"],meaningfulData:["bio","profileImage","followerCount","followingCount"]}},{id:"x-users-by-rest-ids",mappingConfigId:"x-profile",type:"profile",responsePaths:["data.users"],entryExtraction:{path:"",filters:[]},dataMapping:{id:"result.rest_id",bio:"result.legacy.description",displayName:"result.legacy.name",username:"result.legacy.screen_name",profileImage:"result.legacy.profile_image_url_https",followerCount:{path:"result.legacy.followers_count",transform:"toNumber"},followingCount:{path:"result.legacy.friends_count",transform:"toNumber"},verified:"result.legacy.verified",location:"result.legacy.location",website:"result.legacy.url",joinDate:"result.legacy.created_at",postCount:{path:"result.legacy.statuses_count",transform:"toNumber"}},validation:{required:["id","username","displayName"],meaningfulData:["bio","profileImage","followerCount","followingCount"]}},{id:"x-user-timeline",mappingConfigId:"x-profile",type:"profile",responsePaths:["data.user.result.timeline.timeline.instructions"],entryExtraction:{path:"entries",filters:[{field:"content.entryType",values:["TimelineTimelineItem"]},{field:"content.itemContent.itemType",values:["TimelineUser"]}]},dataMapping:{id:"content.itemContent.user_results.result.rest_id",bio:"content.itemContent.user_results.result.legacy.description",displayName:"content.itemContent.user_results.result.legacy.name",username:"content.itemContent.user_results.result.legacy.screen_name",profileImage:"content.itemContent.user_results.result.legacy.profile_image_url_https",followerCount:{path:"content.itemContent.user_results.result.legacy.followers_count",transform:"toNumber"},followingCount:{path:"content.itemContent.user_results.result.legacy.friends_count",transform:"toNumber"},verified:"content.itemContent.user_results.result.legacy.verified",location:"content.itemContent.user_results.result.legacy.location",website:"content.itemContent.user_results.result.legacy.url",joinDate:"content.itemContent.user_results.result.legacy.created_at",postCount:{path:"content.itemContent.user_results.result.legacy.statuses_count",transform:"toNumber"}},validation:{required:["id","username","displayName"],meaningfulData:["bio","profileImage","followerCount","followingCount"]}}]}},passive:{containerSelector:'div[data-testid="primaryColumn"]',itemExtractionConfig:[{id:"x-post",itemSelector:{type:"querySelectorAll",selector:'article[data-testid="tweet"]'},urlPatterns:["^/$","^/home$","^/explore$","^/i/bookmarks$","^/\\w+(?!/status/\\d+)$","^/\\w+/status/\\d+$","^/search.*$"],limit:1,limitOffsetUrlPatterns:["^/\\w+/status/\\d+$"],commands:[{fieldName:"url",type:"querySelector",selector:'a[href*="/status/"]:has(time)',postProcess:"trim",attribute:"href"},{fieldName:"content",type:"querySelector",selector:'div[data-testid="tweetText"]',postProcess:"trim",attribute:"textContent"},{fieldName:"authorName",type:"querySelector",selector:'div[data-testid="User-Name"] > div:first-child span:not(:has(svg))',postProcess:"trim",attribute:"textContent"},{fieldName:"authorHandle",type:"querySelectorAll",selector:'div[data-testid="User-Name"] span',attribute:"textContent",postProcess:[{type:"findWhereIncludes",substring:"@"},{type:"removePrefix",prefix:"@"},"trim"]},{fieldName:"authorUrl",type:"querySelector",selector:'div[data-testid="Tweet-User-Avatar"] a[role="link"]',postProcess:"trim",attribute:"href"},{fieldName:"authorAvatar",type:"querySelector",selector:'div[data-testid="Tweet-User-Avatar"] img',postProcess:"trim",attribute:"src"},{fieldName:"timestamp",type:"querySelector",selector:"a time",postProcess:"trim",attribute:"datetime"},{fieldName:"replies",type:"querySelector",selector:'button[data-testid="reply"] span[data-testid="app-text-transition-container"] > span',postProcess:"trim",attribute:"textContent"},{fieldName:"reposts",type:"querySelector",selector:'button[data-testid="retweet"] span[data-testid="app-text-transition-container"] > span',postProcess:"trim",attribute:"textContent"},{fieldName:"likes",type:"querySelector",selector:'button[data-testid="like"] span[data-testid="app-text-transition-container"] > span',postProcess:"trim",attribute:"textContent"},{fieldName:"views",type:"querySelector",selector:'a[href$="/analytics"] span[data-testid="app-text-transition-container"] > span',postProcess:"trim",attribute:"textContent"},{fieldName:"mediaUrls",type:"querySelectorAll",selector:'div[data-testid="tweetPhoto"] img, div[data-testid="videoComponent"] video',postProcess:"trim",attribute:"src"}]},{id:"x-comment",itemSelector:{type:"querySelectorAll",selector:'article[data-testid="tweet"]'},urlPatterns:["^/\\w+/status/\\d+$"],offset:1,commands:[{fieldName:"url",type:"querySelector",selector:'a[href*="/status/"]:has(time)',postProcess:"trim",attribute:"href"},{fieldName:"content",type:"querySelector",selector:'div[data-testid="tweetText"]',postProcess:"trim",attribute:"textContent"},{fieldName:"authorName",type:"querySelector",selector:'div[data-testid="User-Name"] > div:first-child span:not(:has(svg))',postProcess:"trim",attribute:"textContent"},{fieldName:"authorHandle",type:"querySelectorAll",selector:'div[data-testid="User-Name"] span',attribute:"textContent",postProcess:[{type:"findWhereIncludes",substring:"@"},{type:"removePrefix",prefix:"@"},"trim"]},{fieldName:"authorUrl",type:"querySelector",selector:'div[data-testid="Tweet-User-Avatar"] a[role="link"]',postProcess:"trim",attribute:"href"},{fieldName:"authorAvatar",type:"querySelector",selector:'div[data-testid="Tweet-User-Avatar"] img',postProcess:"trim",attribute:"src"},{fieldName:"timestamp",type:"querySelector",selector:"a time",postProcess:"trim",attribute:"datetime"},{fieldName:"replies",type:"querySelector",selector:'button[data-testid="reply"] span[data-testid="app-text-transition-container"] > span',postProcess:"trim",attribute:"textContent"},{fieldName:"reposts",type:"querySelector",selector:'button[data-testid="retweet"] span[data-testid="app-text-transition-container"] > span',postProcess:"trim",attribute:"textContent"},{fieldName:"likes",type:"querySelector",selector:'button[data-testid="like"] span[data-testid="app-text-transition-container"] > span',postProcess:"trim",attribute:"textContent"},{fieldName:"mediaUrls",type:"querySelectorAll",selector:'div[data-testid="tweetPhoto"] img, div[data-testid="videoComponent"] video',postProcess:"trim",attribute:"src"}]},{id:"x-profile",itemSelector:{type:"querySelector",selector:'div > div > div > div:has(> div[data-testid="UserName"])'},urlPatterns:["^/(?!home$|explore$|i/bookmarks$|search$)\\w+(?!/status/\\d+)$"],commands:[{fieldName:"username",type:"querySelector",selector:'div[data-testid="UserName"] div span:last-child span',attribute:"textContent",postProcess:"trim"},{fieldName:"name",type:"querySelector",selector:'div[data-testid="UserName"] div span:first-child span',attribute:"textContent",postProcess:"trim"},{fieldName:"bio",type:"querySelector",selector:'div[data-testid="UserDescription"]',attribute:"textContent",postProcess:"trim"},{fieldName:"profileImage",type:"querySelector",selector:'div[data-testid^="UserAvatar-Container"] a[href$="/photo"] img',attribute:"src"},{fieldName:"followerCount",type:"querySelector",selector:'a[href$="/verified_followers"] span:first-child span',attribute:"textContent",postProcess:"trim"},{fieldName:"followingCount",type:"querySelector",selector:'a[href$="/following"] span:first-child span',attribute:"textContent",postProcess:"trim"},{fieldName:"location",type:"querySelector",selector:'span[data-testid="UserLocation"] span span',attribute:"textContent",postProcess:"trim"},{fieldName:"website",type:"querySelector",selector:'a[data-testid="UserUrl"]',attribute:"href"},{fieldName:"websiteText",type:"querySelector",selector:'a[data-testid="UserUrl"] span',attribute:"textContent",postProcess:"trim"},{fieldName:"joinDate",type:"querySelector",selector:'span[data-testid="UserJoinDate"] span',attribute:"textContent",postProcess:"trim"},{fieldName:"verified",type:"querySelector",selector:'svg[data-testid="icon-verified"]',attribute:"data-testid"}]},{id:"x-follow-card",itemSelector:{type:"querySelector",selector:'button[data-testid="UserCell"]'},urlPatterns:["^/\\w+/following$","^/\\w+/followers$","^/i/connect_people$"],commands:[{fieldName:"name",type:"querySelector",selector:'div[class*="r-1awozwy"][class*="r-18u37iz"] > div:first-child a[role="link"] span > span:first-child',attribute:"textContent",postProcess:"trim"},{fieldName:"username",type:"querySelectorAll",selector:'div[class*="r-1awozwy"][class*="r-18u37iz"][class*="r-1wtj0ep"] a[role="link"] span',attribute:"textContent",postProcess:[{type:"findWhereIncludes",substring:"@"},{type:"removePrefix",prefix:"@"},"trim"]},{fieldName:"profileUrl",type:"querySelector",selector:'div[class*="r-1awozwy"][class*="r-18u37iz"][class*="r-1wtj0ep"] a[role="link"]',attribute:"href"},{fieldName:"avatarUrl",type:"querySelector",selector:'div[data-testid^="UserAvatar-Container"] img',attribute:"src"},{fieldName:"bio",type:"querySelector",selector:'div[class*="r-1iusvr4"] > div[dir="auto"]',attribute:"textContent",postProcess:"trim"},{fieldName:"verified",type:"querySelector",selector:'div[class*="r-1awozwy"][class*="r-18u37iz"][class*="r-1wtj0ep"] svg[data-testid="icon-verified"]',attribute:"data-testid"}]}]}}},gatheringConfig:{whitelist:[]}};let g=null;chrome.storage.local.get("config",o=>{o.config?g=o.config||v:g=v}),chrome.storage.onChanged.addListener(o=>{o.config&&(g=o.config.newValue||v)});const D=()=>g||v;class Q{constructor(r){u(this,"platform");u(this,"isGatheringEnabled",!0);u(this,"isInitialized",!1);u(this,"observer",null);console.log("Platform:",r),this.platform=r,this.initializeMessageListener(),this.checkPlatformSettings()}checkPlatformSettings(){chrome.storage.local.get(["platformSettings","activeJobContext"],r=>{console.log({result:r}),console.log({platform:this.platform});const e=r.platformSettings||{[this.platform.id]:!0};this.isGatheringEnabled=e[this.platform.id],this.isInitialized=e[this.platform.id],e[this.platform.id]&&this.initializeObserver()})}initializeMessageListener(){chrome.runtime.onMessage.addListener(r=>{r.type==="DISABLE_GATHERING"?(this.isGatheringEnabled=!1,this.isInitialized=!1,this.observer&&(this.observer.disconnect(),this.observer=null)):r.type==="ENABLE_GATHERING"&&(this.isGatheringEnabled=!0,this.isInitialized=!0,this.observer||this.initializeObserver())}),chrome.storage.onChanged.addListener(r=>{if(r.platformSettings){const e=r.platformSettings.newValue;this.isGatheringEnabled=e[this.platform.id],this.isInitialized=e[this.platform.id],e[this.platform.id]?this.observer||this.initializeObserver():this.observer&&(this.observer.disconnect(),this.observer=null)}})}}const Z={},z=!1;function i(...o){z&&console.info("[safeWarn]",...o)}function m(...o){z&&console.info("[safeError]",...o)}function x(o,r){return!r||!o?null:o.querySelector(r)}function V(o,r){return!r||!o?[]:o.querySelectorAll(r)}function tt(o,r){if(!r)return o;const e=Array.isArray(r)?r:[r];let t=o;for(const s of e){if(t==null)break;try{if(typeof s=="string")switch(s){case"trim":t=typeof t=="string"?t.trim():t;break;case"toNumber":if(typeof t=="string"){const n=parseFloat(t.replace(/,/g,""));t=isNaN(n)?void 0:n}else typeof t!="number"&&(t=void 0);break;case"toDate":if(typeof t=="string"){const n=new Date(t);t=isNaN(n.getTime())?void 0:n.toISOString()}else t instanceof Date||(t=void 0);break;case"toBoolean":t=!!t;break;case"resolveUrl":if(typeof t=="string")try{t=new URL(t,document.baseURI).href}catch(n){i(`[PostProcess] Could not resolve URL: ${t}`,n)}break;case"toLowerCase":t=typeof t=="string"?t.toLowerCase():t;break;case"toUpperCase":t=typeof t=="string"?t.toUpperCase():t;break;default:i(`[PostProcess] Unknown post-processing step: ${s}`)}else if(typeof s=="object")switch(s.type){case"removePrefix":typeof t=="string"&&t.startsWith(s.prefix)&&(t=t.substring(s.prefix.length));break;case"removeSuffix":typeof t=="string"&&t.endsWith(s.suffix)&&(t=t.substring(0,t.length-s.suffix.length));break;case"replace":typeof t=="string"&&(t=t.replace(s.searchValue,s.replaceValue));break;case"matchRegex":if(typeof t=="string"){const n=t.match(new RegExp(s.regex));t=n?s.groupIndex!==void 0?n[s.groupIndex]:n[0]:void 0}break;case"split":if(typeof t=="string"){const n=t.split(s.delimiter);t=n.length>s.index?n[s.index]:void 0}break;case"join":Array.isArray(t)&&(t=t.join(s.delimiter));break;case"findWhereIncludes":Array.isArray(t)&&(t=t.find(n=>typeof n=="string"&&n.includes(s.substring)));break;default:i(`[PostProcess] Unknown object-based post-processing step type: ${s==null?void 0:s.type}`)}}catch(n){m(`[PostProcess] Error applying step ${JSON.stringify(s)} to value ${t}:`,n),t=void 0;break}}return t}function et(o,r){var t,s,n;const e={};for(const a of r){let l;try{switch(a.type){case"getText":l=(t=x(o,a.selector))==null?void 0:t.textContent;break;case"getAttribute":l=(s=x(o,a.selector))==null?void 0:s.getAttribute(a.attribute);break;case"getHTML":l=(n=x(o,a.selector))==null?void 0:n.innerHTML;break;case"getAllAttributes":l=Array.from(V(o,a.selector)).map(c=>c.getAttribute(a.attribute)).filter(c=>c!==null);break;case"elementExists":l=!!x(o,a.selector);break;case"getCssProperty":{const c=x(o,a.selector);l=c?window.getComputedStyle(c).getPropertyValue(a.cssProperty):void 0;break}case"getDataset":{const c=x(o,a.selector);l=c==null?void 0:c.dataset[a.dataAttribute];break}case"getAllTextContents":l=Array.from(V(o,a.selector)).map(c=>c.textContent).filter(c=>typeof c=="string"&&c.trim().length>0);break;default:i(`[ExtractionExecutor] Unknown command type: ${a.type}`)}const d=tt(l,a.postProcess);d!==void 0&&(e[a.resultKey]=d)}catch(d){m(`[ExtractionExecutor] Error executing command for key "${a.resultKey}" (Selector: ${a.selector}):`,d)}}return e}const it={POPUP:"POPUP",BACKGROUND:"BACKGROUND",CONTENT:"CONTENT",OFFSCREEN:"OFFSCREEN"},B={SYNC_GATHERED_DATA:"SYNC_GATHERED_DATA",SYNC_FULL_CONFIG:"SYNC_FULL_CONFIG"};function K(o){return o?Object.values(o).reduce((e,t)=>e+((t==null?void 0:t.length)??0),0):0}function yt(o){return o}async function I(o){try{return new Promise((r,e)=>{chrome.runtime.sendMessage({type:"GET_STORAGE_DATA",keys:o},t=>{chrome.runtime.lastError?e(new Error(chrome.runtime.lastError.message)):t!=null&&t.error?e(new Error(t.error)):r((t==null?void 0:t.data)||{})})})}catch(r){return m("Error getting storage data via background:",r),{}}}async function Y(o){try{return new Promise((r,e)=>{chrome.runtime.sendMessage({type:"SET_STORAGE_DATA",data:o},t=>{chrome.runtime.lastError?e(new Error(chrome.runtime.lastError.message)):t!=null&&t.error?e(new Error(t.error)):r((t==null?void 0:t.success)||!1)})})}catch(r){return m("Error setting storage data via background:",r),!1}}async function k(){try{return await I(["autoScrollEnabled","isConnected","passiveGatheringEnabled"])}catch(o){return m("Error getting gather content storage:",o),{autoScrollEnabled:!1,isConnected:!1,passiveGatheringEnabled:!1}}}function rt(o){return o.map(e=>{const t={resultKey:e.fieldName,selector:e.selector,postProcess:e.postProcess};switch(e.type){case"getText":return{...t,type:"getText"};case"getAttribute":return e.attribute?{...t,type:"getAttribute",attribute:e.attribute}:(i(`'getAttribute' command for field '${e.fieldName}' missing 'attribute' property.`),{...t,type:"getText"});case"getHTML":return{...t,type:"getHTML"};case"getAllAttributes":return e.attribute?{...t,type:"getAllAttributes",attribute:e.attribute}:(i(`'getAllAttributes' command for field '${e.fieldName}' missing 'attribute' property.`),null);case"elementExists":return{...t,type:"elementExists"};case"getCssProperty":return e.cssProperty?{...t,type:"getCssProperty",cssProperty:e.cssProperty}:(i(`'getCssProperty' command for field '${e.fieldName}' missing 'cssProperty' property.`),null);case"getDataset":return e.dataAttribute?{...t,type:"getDataset",dataAttribute:e.dataAttribute}:(i(`'getDataset' command for field '${e.fieldName}' missing 'dataAttribute' property.`),null);case"querySelector":return e.attribute&&e.attribute!=="textContent"?{...t,type:"getAttribute",attribute:e.attribute}:{...t,type:"getText"};case"querySelectorAll":return e.attribute&&e.attribute!=="textContent"?{...t,type:"getAllAttributes",attribute:e.attribute}:{...t,type:"getAllTextContents"};default:return i(`Unknown config command type: ${e.type} for field ${e.fieldName}. Skipping.`),null}}).filter(e=>e!==null)}function st(o){const r=new Date().toISOString(),e=window.location.href;return{jobAssociations:void 0,gatheredAt:r,gatherType:o?"autonomous":"observer",sourceUrl:e}}function nt(o,r){const e=st(r);return{...o,metadata:e}}class ot extends Q{constructor(e){var n,a;super(e.platform);u(this,"itemExtractionConfigs");u(this,"maxCaptures",50);u(this,"connectionStateDebounceTimer",null);u(this,"CONNECTION_DEBOUNCE_TIME",5e3);u(this,"DEBOUNCE_DELAY",300);u(this,"isPassiveGatheringEnabled",!1);u(this,"isAutoscrollEnabled",!1);u(this,"lastScrollPosition",0);u(this,"autoScrollInterval");u(this,"noScrollCount",0);u(this,"MAX_NO_SCROLL_ATTEMPTS",3);u(this,"lastRefreshTime",Date.now());u(this,"isProcessing",!1);u(this,"recentlyProcessedItems",new Set);u(this,"RECENT_ITEMS_TTL",3e4);u(this,"recentItemsCleanupInterval");u(this,"lastSuccessfulGather",Date.now());u(this,"GATHER_HEALTH_CHECK_INTERVAL",15e3);u(this,"MAX_GATHER_INACTIVITY_AUTONOMOUS",6e4);u(this,"MAX_GATHER_INACTIVITY_OBSERVER",12e4);u(this,"gatherHealthCheckInterval");u(this,"lastScrollTime",Date.now());u(this,"SCROLL_ACTIVITY_THRESHOLD",12e4);u(this,"SCROLL_DISTANCE_THRESHOLD",100);u(this,"consecutiveFailedAttempts",0);u(this,"MAX_CONSECUTIVE_FAILURES",2);u(this,"CONTINUOUS_OPERATION_TIME",9e5);u(this,"BREAK_DURATION",3e5);u(this,"operationStartTime",0);u(this,"isOnBreak",!1);u(this,"breakTimeout");u(this,"MIN_SCROLL_INTERVAL",1500);u(this,"MAX_SCROLL_INTERVAL",6e3);u(this,"nextScrollTime",0);u(this,"selfHealInterval");u(this,"storageListeners",[]);u(this,"recoveryTimeout");u(this,"elementDataCache",new WeakMap);u(this,"refreshIntervalMs",this.getRandomRefreshInterval());u(this,"debouncedProcessFeed",this.debounce(()=>this.processFeed(),this.DEBOUNCE_DELAY));u(this,"debouncedHandleConnectionStateChange",this.debounce(()=>this.handleConnectionStateChange(),this.CONNECTION_DEBOUNCE_TIME));u(this,"_isConnected",!1);u(this,"handleScroll",()=>{if(!this.isConnected||this.autoScrollInterval!==void 0)return;const e=window.scrollY,t=Date.now();Math.abs(e-this.lastScrollPosition)>this.SCROLL_DISTANCE_THRESHOLD&&(this.lastScrollPosition=e,this.lastScrollTime=t,this.debouncedProcessFeed())});u(this,"autonomousCooldownTimeout");u(this,"AUTONOMOUS_MIN_RUNTIME",72e5);u(this,"AUTONOMOUS_MAX_RUNTIME",144e5);u(this,"autonomousModeStartTime");u(this,"autonomousModeLocked",!1);i("DynamicContentScript constructing with config:",e),this.recentItemsCleanupInterval=window.setInterval(()=>{this.recentlyProcessedItems.clear(),this.clearElementDataCache()},this.RECENT_ITEMS_TTL),I(["isConnected","autoScrollEnabled","passiveGatheringEnabled"]).then(l=>{this.isConnected=!!l.isConnected,this.isAutoscrollEnabled=!!l.autoScrollEnabled,this.isPassiveGatheringEnabled=!!l.passiveGatheringEnabled,i("[ContentScript] Initial connection state:",{isConnected:this.isConnected,isAutoscrollEnabled:this.isAutoscrollEnabled,isPassiveGatheringEnabled:this.isPassiveGatheringEnabled}),Y({passiveGatheringEnabled:!0})}).catch(l=>{m("[ContentScript] Error getting initial storage state:",l),this.isConnected=!1,this.isAutoscrollEnabled=!1,this.isPassiveGatheringEnabled=!1});const t=l=>{let d=!1;l.isConnected&&(this.isConnected=l.isConnected.newValue,d=!0),l.autoScrollEnabled&&(this.isAutoscrollEnabled=l.autoScrollEnabled.newValue,d=!0),l.passiveGatheringEnabled&&(this.isPassiveGatheringEnabled=l.passiveGatheringEnabled.newValue,d=!0),d&&this.debouncedHandleConnectionStateChange()};chrome.storage.onChanged.addListener(t),this.storageListeners.push(()=>chrome.storage.onChanged.removeListener(t)),this.itemExtractionConfigs=(a=(n=e.platform.gathering)==null?void 0:n.passive)==null?void 0:a.itemExtractionConfig,!this.itemExtractionConfigs||this.itemExtractionConfigs.length===0?i(`[DynamicContentScript] Platform ${e.platform.id} has no passive itemExtractionConfig defined.`):i(`[DynamicContentScript] Loaded ${this.itemExtractionConfigs.length} item extraction configs for ${e.platform.id}.`),I(["config"]).then(l=>{const d=D()||l.config;d!=null&&d.generalConfig&&(this.maxCaptures=d.generalConfig.maxCaptures),i(`[DynamicContentScript] Max captures set to: ${this.maxCaptures}`)}).catch(l=>{m("[DynamicContentScript] Error getting config:",l)});const s=l=>{if(l.config){const d=l.config.newValue;if(d!=null&&d.generalConfig){const c=this.maxCaptures;this.maxCaptures=d.generalConfig.maxCaptures,c!==this.maxCaptures&&i(`[DynamicContentScript] Max captures updated to: ${this.maxCaptures}`)}}};chrome.storage.onChanged.addListener(s),this.storageListeners.push(()=>chrome.storage.onChanged.removeListener(s)),chrome.runtime.sendMessage({type:"FORCE_WEBSOCKET_STATE_SYNC"}),this.selfHealInterval=window.setInterval(async()=>{try{const l=await I(["isConnected","autoScrollEnabled","passiveGatheringEnabled"]);!!l.isConnected&&!!l.passiveGatheringEnabled&&!this.isGatheringEnabled&&(i("[ContentScript] Periodic self-heal: attempting to re-enable gathering"),this.enableGathering())}catch(l){m("[ContentScript] Error in periodic self-heal:",l)}},15e3)}clearElementDataCache(){this.elementDataCache=new WeakMap,i("[DynamicContentScript] Element data cache cleared")}getCurrentAutonomousRuntime(){if(this.autonomousModeStartTime)return Date.now()-this.autonomousModeStartTime}getRandomRefreshInterval(){return 15e4+Math.random()*15e4}getRandomScrollInterval(){let s=Math.round(this.randomNormal(4e3,1500));return s=Math.max(this.MIN_SCROLL_INTERVAL,Math.min(this.MAX_SCROLL_INTERVAL,s)),s}randomNormal(e,t){let s=0,n=0;for(;s===0;)s=Math.random();for(;n===0;)n=Math.random();return e+t*Math.sqrt(-2*Math.log(s))*Math.cos(2*Math.PI*n)}getRandomScrollDistance(){const e=350+Math.random()*100,t=Math.random()<.5;let s;return t?s=e*(1+Math.floor(Math.random()*3)):s=window.innerHeight*(.6+Math.random()*.6),s}smoothScrollTo(e,t=800){const s=window.scrollY,n=e-s,a=performance.now();function l(c){return c<.5?2*c*c:-1+(4-2*c)*c}function d(c){const E=c-a,p=Math.min(E/t,1),S=l(p);window.scrollTo(0,s+n*S),p<1&&requestAnimationFrame(d)}requestAnimationFrame(d)}scheduleNextScroll(){this.autoScrollInterval!==void 0&&clearInterval(this.autoScrollInterval);const e=this.getRandomScrollInterval();this.nextScrollTime=Date.now()+e,i("[AutoScroll] Scheduled next scroll:",{nextScrollIn:`${Math.round(e/1e3)} seconds`,scheduledFor:new Date(this.nextScrollTime).toLocaleTimeString(),currentTime:new Date().toLocaleTimeString()}),this.autoScrollInterval=window.setTimeout(()=>{this.performScroll()},e)}async performScroll(){try{const t=Date.now()-this.operationStartTime;if(!this.isOnBreak&&t>=this.CONTINUOUS_OPERATION_TIME){i("[AutoScroll] Taking a break after continuous operation"),this.isOnBreak=!0,this.stopAutoScroll(),this.breakTimeout=window.setTimeout(()=>{i("[AutoScroll] Break ended, resuming operation"),this.isOnBreak=!1,this.operationStartTime=Date.now(),this.startAutoScroll()},this.BREAK_DURATION);return}if(this.isOnBreak)return;const s=await k();if(i("[AutoScroll] Checking storage state:",s),!this.isConnected||!s.isConnected||!s.autoScrollEnabled||!s.passiveGatheringEnabled){i("[AutoScroll] Stopping due to conditions not met:",s,this.isConnected),this.stopAutoScroll();return}const n=window.scrollY,a=this.getRandomScrollDistance(),l=n+a,d=600+Math.random()*600;this.smoothScrollTo(l,d),setTimeout(async()=>{try{const c=await k();if(!c.isConnected||!c.autoScrollEnabled||!c.passiveGatheringEnabled){i("[AutoScroll] Stopping due to conditions not met during scroll:",{isConnected:c.isConnected,autoScrollEnabled:c.autoScrollEnabled,passiveGatheringEnabled:c.passiveGatheringEnabled}),this.stopAutoScroll();return}await this.checkAndRefresh(),this.isAutoscrollEnabled&&!this.isOnBreak&&this.scheduleNextScroll()}catch(c){m("[AutoScroll] Error in setTimeout callback:",c)}},1e3)}catch(e){m("[AutoScroll] Error in performScroll:",e)}}debounce(e,t){let s;return function(...n){s!==void 0&&clearTimeout(s),s=window.setTimeout(()=>e.apply(this,n),t)}}get isConnected(){return this._isConnected}set isConnected(e){this._isConnected!==e&&(this._isConnected=e,this.debouncedHandleConnectionStateChange())}async handleConnectionStateChange(){i("[ContentScript] handleConnectionStateChange",{isConnected:this.isConnected,isAutoscrollEnabled:this.isAutoscrollEnabled,isPassiveGatheringEnabled:this.isPassiveGatheringEnabled}),this.isConnected&&this.isPassiveGatheringEnabled?this.startProcesses():(this.stopProcesses({autoScroll:!0}),i("[ContentScript] DISABLE_GATHERING due to state",{isConnected:this.isConnected,isPassiveGatheringEnabled:this.isPassiveGatheringEnabled,isAutoscrollEnabled:this.isAutoscrollEnabled}))}initialize(){this.isInitialized||(this.isInitialized=!0,i("[DynamicContentScript] Initialized."),this.isConnected&&this.isGatheringEnabled&&this.startGathering())}enableGathering(){this.isGatheringEnabled||(i("[DynamicContentScript] Enabling gathering request."),this.isGatheringEnabled=!0,this.isConnected&&this.isInitialized&&this.startGathering())}disableGathering(){this.isGatheringEnabled&&(i("[DynamicContentScript] Disabling gathering request."),this.isGatheringEnabled=!1,this.stopGathering())}cleanup(){this.isInitialized=!1,this.isGatheringEnabled=!1,this.isConnected=!1,this.observer&&(this.observer.disconnect(),this.observer=null),this.connectionStateDebounceTimer!==null&&(clearTimeout(this.connectionStateDebounceTimer),this.connectionStateDebounceTimer=null),this.recentItemsCleanupInterval!==void 0&&(clearInterval(this.recentItemsCleanupInterval),this.recentItemsCleanupInterval=void 0),this.selfHealInterval!==void 0&&(clearInterval(this.selfHealInterval),this.selfHealInterval=void 0),this.gatherHealthCheckInterval!==void 0&&(clearInterval(this.gatherHealthCheckInterval),this.gatherHealthCheckInterval=void 0),this.stopGatherHealthCheck(),this.recoveryTimeout!==void 0&&(clearTimeout(this.recoveryTimeout),this.recoveryTimeout=void 0),this.storageListeners.forEach(e=>e()),this.storageListeners=[],this.clearElementDataCache(),this.recentlyProcessedItems.clear()}startGathering(){i("[DynamicContentScript] Starting gathering"),this.isGatheringEnabled=!0,this.isInitialized=!0,this.initializeObserver()}stopGathering(){i("[DynamicContentScript] Stopping gathering"),this.isGatheringEnabled=!1,this.observer&&(this.observer.disconnect(),this.observer=null)}extractData(){var n,a,l,d;if(!this.isGatheringEnabled||!this.isInitialized||!this.isConnected||!this.itemExtractionConfigs||this.itemExtractionConfigs.length===0)return this.isConnected||i("[DynamicContentScript] Not connected, skipping data extraction"),{items:[]};const e=[];let t=0;const s=window.location.pathname;for(const c of this.itemExtractionConfigs){if(!((n=c==null?void 0:c.itemSelector)!=null&&n.selector)){i(`[DynamicContentScript] Skipping extraction config '${c.id}': No valid itemSelector found for ${this.platform.id}`);continue}let E=!0;if(c.urlPatterns&&c.urlPatterns.length>0&&(E=c.urlPatterns.some(w=>{try{return new RegExp(w).test(s)}catch(C){return m(`[DynamicContentScript] Invalid regex pattern '${w}' in config '${c.id}':`,C),!1}}),!E)){i(`[DynamicContentScript] Skipping config '${c.id}' as current path '${s}' does not match its urlPatterns.`);continue}if(t>=this.maxCaptures){i(`[DynamicContentScript] Reached max captures limit (${this.maxCaptures}) before processing config '${c.id}'.`);break}const p=c.itemSelector.selector,S=c.itemSelector.type,h=c.id;let G=0;h==="x-profile"&&i(`[DynamicContentScript] Attempting to process config: '${h}'`);try{const w=document.querySelectorAll(p);let C=Array.from(w);const M=c.offset??0,q=c.limit;if((q!==void 0||M>0)&&S!=="querySelectorAll")i(`[DynamicContentScript] Config '${h}' uses limit/offset but itemSelector type is not 'querySelectorAll'. Limit/offset will be ignored.`);else if(S==="querySelectorAll"){let T=!c.limitOffsetUrlPatterns||c.limitOffsetUrlPatterns.length===0;if(!T&&c.limitOffsetUrlPatterns&&(T=c.limitOffsetUrlPatterns.some(A=>{try{return new RegExp(A).test(s)}catch(f){return m(`[DynamicContentScript] Invalid regex in limitOffsetUrlPatterns for config '${h}': ${A}`,f),!1}})),T){const A=C.length;q!==void 0?C=C.slice(M,M+q):M>0&&(C=C.slice(M)),C.length!==A&&i(`[DynamicContentScript] Applied limit/offset to config '${h}'. Processing ${C.length} of ${A} elements.`)}}i(`[DynamicContentScript] Found ${w.length} potential items, processing ${C.length} for config '${h}'`);for(const T of C){if(t>=this.maxCaptures){i(`[DynamicContentScript] Reached max captures limit (${this.maxCaptures}) while processing items for config '${h}'.`);break}if(T instanceof HTMLElement)try{const A=rt(c.commands);let f;const W=this.elementDataCache.get(T);W?(f=W,i(`[DynamicContentScript] Using cached data for element in config '${h}'`)):(f=et(T,A),this.elementDataCache.set(T,f));let y,_=f.url;if(h==="x-comment"&&_){const b=((a=f.content)==null?void 0:a.substring(0,10))||Math.random().toString(36).substring(2,8),N=f.authorHandle||"anon";y=`${_}#comment-${N}-${b}`}else y=_;if(h==="reddit-subreddit"){const b=f.name;if(b)_=`https://www.reddit.com/${b}`,y=_;else{i("[DynamicContentScript] Skipping reddit-subreddit item due to missing name for ID/URL construction.");continue}}else if(h==="reddit-profile"){const b=window.location.pathname.split("/"),N=b.length>2&&b[1]==="user"?b[2]:void 0;if(N)_=`https://www.reddit.com/user/${N}/`,y=_,f.username||(f.username=N);else{i(`[DynamicContentScript] Skipping reddit-profile item due to unable to extract username from path: ${window.location.pathname}`);continue}}if(y||(y=_),!y){const b=f.username;if(b)y=`${this.platform.id}-${h}-${b}`;else{i(`[DynamicContentScript] Item from config '${h}' lacks a reliable ID (URL/Username/Subreddit Name/Profile Path). Generating fallback. Extracted data:`,f);const N=((l=f.name)==null?void 0:l.substring(0,10))||"no-name",gt=((d=f.bio)==null?void 0:d.substring(0,20))||"no-bio";y=`${this.platform.id}-${h}-${N}-${gt}-${Math.random().toString(36).substring(2,8)}`,i(`[DynamicContentScript] Generated fallback ID: ${y}`)}}const ft={platform:this.platform.id,id:y,configId:h,url:_||"",data:f},J=nt(ft,this.isAutoscrollEnabled);e.push(J),G++,t++,h==="x-profile"&&i(`[DynamicContentScript] Successfully extracted item for config: '${h}'`,J)}catch(A){m(`[DynamicContentScript] Error extracting item with config ${h}:`,A,T);continue}}i(`[DynamicContentScript] Extracted ${G} items using config '${h}'. Total items so far: ${t}.`)}catch(w){m(`[DynamicContentScript] Error querying elements with selector ${p} for config '${h}':`,w)}}return{items:e}}shouldProcessData(e){return!!(e.items&&e.items.length>0)}async sendDataToBackground(e){if(!e.items||e.items.length===0){i("[DynamicContentScript] sendDataToBackground called with no items.");return}i(`[DynamicContentScript] Preparing to save ${e.items.length} items to local storage.`);try{const s=(await I(["gatheredData"])).gatheredData||{},n={};e.items.forEach(d=>{n[d.platform]||(n[d.platform]=[]),n[d.platform].push(d)});let a=0,l=!1;for(const d in n){s[d]||(s[d]=[]);const c=new Map;s[d].forEach(p=>{const S=p.url||p.id;S&&c.set(S,p)});const E=n[d].filter(p=>{const S=p.url||p.id;if(!S)return i("[DynamicContentScript] Item missing stable identifier:",p),!1;const h=c.get(S);if(!h)return!0;const G=JSON.stringify(p.data),w=JSON.stringify(h.data);return G!==w&&(i(`[DynamicContentScript] Content changed for item ${S}, updating...`),h.data=p.data,h.metadata.gatheredAt=p.metadata.gatheredAt,l=!0),!1});E.length>0&&(s[d].push(...E),a+=E.length,l=!0)}if(l){await Y({gatheredData:s}),i(`[DynamicContentScript] Successfully saved ${a} new items to chrome.storage.local. Total items by platform:`,Object.fromEntries(Object.entries(s).map(([c,E])=>[c,E.length])));const d=K(s);i(`[DynamicContentScript] Overall stored items across platforms: ${d}`)}else i("[DynamicContentScript] No new unique items to add to local storage.")}catch(t){m("[DynamicContentScript] Error saving data to chrome.storage.local:",t)}chrome.runtime.sendMessage({target:"background",type:`${this.platform.id.toUpperCase()}_FEED`,data:{items:e.items}}).catch(t=>{m("[DynamicContentScript] Error sending message to background:",t)})}initializeObserver(){var a,l;if(!this.isGatheringEnabled||!this.isInitialized||!this.isConnected){i("[DynamicContentScript] Cannot initialize observer - conditions not met:",{isGatheringEnabled:this.isGatheringEnabled,isInitialized:this.isInitialized,isConnected:this.isConnected});return}const e=(l=(a=this.platform.gathering)==null?void 0:a.passive)==null?void 0:l.containerSelector;let t=null;e&&(t=document.querySelector(e),i(t?`[DynamicContentScript] Found specified container: ${e}`:`[DynamicContentScript] Specified containerSelector '${e}' not found for platform ${this.platform.id}. Falling back to observing document.body.`));const s=t||document.body,n=e&&t?e:"document.body";i(`[DynamicContentScript] Initializing observer for ${this.platform.id} on target: ${n}`),this.observer&&(this.observer.disconnect(),i("[DynamicContentScript] Disconnected previous observer.")),this.observer=new MutationObserver(()=>{this.debouncedProcessFeed()}),this.observer.observe(s,{childList:!0,subtree:!0}),this.debouncedProcessFeed()}async checkAndRefresh(){if(!(await k()).isConnected){i("[AutoScroll] Cannot check refresh - WebSocket not connected"),this.stopAllProcesses();return}if(!this.isAutoscrollEnabled)return;const t=Date.now();if(t-this.lastRefreshTime>=this.refreshIntervalMs){i("[AutoScroll] Randomized interval passed, refreshing page..."),this.lastRefreshTime=t,this.refreshIntervalMs=this.getRandomRefreshInterval(),this.noScrollCount=0,window.location.reload();return}const n=window.scrollY;Math.abs(n-this.lastScrollPosition)>100?(this.noScrollCount=0,this.lastScrollPosition=n,this.debouncedProcessFeed()):(this.noScrollCount++,i(`[AutoScroll] No scroll movement detected. Attempt ${this.noScrollCount}/${this.MAX_NO_SCROLL_ATTEMPTS}`),this.noScrollCount>=this.MAX_NO_SCROLL_ATTEMPTS&&(i("[AutoScroll] Max scroll attempts reached, refreshing page..."),this.refreshIntervalMs=this.getRandomRefreshInterval(),this.noScrollCount=0,this.lastRefreshTime=t,this.isAutoscrollEnabled&&window.location.reload()))}processFeed(){var e;if(this.isProcessing){i("[DynamicContentScript] Already processing, skipping this batch");return}this.isProcessing=!0;try{if(!this.isGatheringEnabled||!this.isInitialized||!this.isConnected){this.isConnected||i("[DynamicContentScript] Not connected, skipping feed processing");return}if(!this.itemExtractionConfigs){i(`[DynamicContentScript] Skipping processFeed for ${this.platform.id} - no itemExtractionConfigs.`);return}const t=this.extractData();if(t.items&&t.items.length>0){const n=t.items.filter(a=>this.recentlyProcessedItems.has(a.id)?(i(`[DynamicContentScript] Skipping recently processed item: ${a.id}`),!1):(this.recentlyProcessedItems.add(a.id),!0));if(n.length===0){i("[DynamicContentScript] All items in batch were recently processed, skipping");return}t.items=n}i("Data extracted:",t);const s=((e=t.items)==null?void 0:e.length)??0;i(`[DynamicContentScript] Batch extracted items: ${s}`),s>0&&(this.lastSuccessfulGather=Date.now()),I(["gatheredData"]).then(n=>{const a=K(n.gatheredData);i(`[DynamicContentScript] Total stored items across platforms: ${a}`),chrome.runtime.sendMessage({target:it.BACKGROUND,type:"UPDATE_BADGE_COUNT",data:{total:a}})}).catch(n=>{m("[DynamicContentScript] Error getting gathered data:",n)}),this.shouldProcessData(t)&&this.sendDataToBackground(t)}finally{this.isProcessing=!1}}stopAllProcesses(){i("[DynamicContentScript] Stopping all processes"),this.stopProcesses({autoScroll:!0}),this.stopGatherHealthCheck()}startProcesses(e={}){i("[DynamicContentScript] Starting processes with options:",e),this.initialize(),this.isConnected&&(this.enableGathering(),I(["autoScrollEnabled"]).then(t=>{t.autoScrollEnabled&&this.startAutoScroll()}).catch(t=>{m("[DynamicContentScript] Error getting autoScrollEnabled:",t)}),this.startGatherHealthCheck())}stopProcesses(e={}){i("[DynamicContentScript] Stopping processes with options:",e),(!this.isConnected||e.autoScroll===void 0||e.autoScroll===!0)&&this.stopAutoScroll(),chrome.runtime.sendMessage({type:"GET_HEALTH_CHECK_INFO"},t=>{if(chrome.runtime.lastError){m("[DynamicContentScript] Error getting health check info:",chrome.runtime.lastError);return}if(!t){i("[DynamicContentScript] No response from background script");return}const{isManuallyDisconnected:s}=t;s&&(this.disableGathering(),this.cleanup(),this.stopGatherHealthCheck())})}getRandomAutonomousRuntime(){return this.AUTONOMOUS_MIN_RUNTIME+Math.random()*(this.AUTONOMOUS_MAX_RUNTIME-this.AUTONOMOUS_MIN_RUNTIME)}startAutonomousCooldown(){this.autonomousCooldownTimeout!==void 0&&clearTimeout(this.autonomousCooldownTimeout),this.autonomousModeStartTime=Date.now();const e=this.getRandomAutonomousRuntime();i(`[AutonomousMode] Cooldown timer started for ${(e/36e5).toFixed(2)} hours.`),this.autonomousCooldownTimeout=window.setTimeout(()=>{this.triggerAutonomousCooldown()},e)}triggerAutonomousCooldown(){const e=this.getCurrentAutonomousRuntime();if(e){const t=(e/36e5).toFixed(2);i(`[AutonomousMode] Cooldown triggered after ${t} hours of autonomous operation. Forcing switch to observer mode. User must manually reconnect to resume autonomous mode.`)}else i("[AutonomousMode] Cooldown triggered: Forcing switch to observer mode. User must manually reconnect to resume autonomous mode.");this.autonomousModeLocked=!0,this.isAutoscrollEnabled=!1,this.stopAutoScroll()}clearAutonomousCooldown(){this.autonomousCooldownTimeout!==void 0&&(clearTimeout(this.autonomousCooldownTimeout),this.autonomousCooldownTimeout=void 0),this.autonomousModeStartTime=void 0,this.autonomousModeLocked=!1}async startAutoScroll(){if(!this.isConnected){i("[AutoScroll] Cannot start - Not connected");return}if(this.autonomousModeLocked){i("[AutonomousMode] Autonomous mode is locked due to cooldown. User must manually reconnect.");return}i("[AutoScroll] Starting process with full state:",{hasExistingInterval:this.autoScrollInterval!==void 0,isConnected:this.isConnected,isAutoscrollEnabled:this.isAutoscrollEnabled,isPassiveGatheringEnabled:this.isPassiveGatheringEnabled}),this.autoScrollInterval!==void 0&&(i("[AutoScroll] Stopping existing interval"),this.stopAutoScroll()),this.isAutoscrollEnabled=!0,this.lastScrollPosition=window.scrollY,this.noScrollCount=0,this.operationStartTime=Date.now(),this.isOnBreak=!1,i("[AutoScroll] Starting with randomized intervals"),this.scheduleNextScroll(),this.startAutonomousCooldown()}stopAutoScroll(){if(this.autoScrollInterval!==void 0){const e=this.nextScrollTime-Date.now();i("[DynamicContentScript] Stopping auto-scroll",{timeUntilNextScroll:e>0?`${Math.round(e/1e3)} seconds`:"immediate",nextScheduledTime:new Date(this.nextScrollTime).toLocaleTimeString()}),clearTimeout(this.autoScrollInterval),this.autoScrollInterval=void 0,this.isAutoscrollEnabled=!1,this.noScrollCount=0,this.nextScrollTime=0}this.breakTimeout!==void 0&&(clearTimeout(this.breakTimeout),this.breakTimeout=void 0),this.clearAutonomousCooldown()}manualReconnectAutonomousMode(){this.autonomousModeLocked&&(i("[AutonomousMode] User manually reconnected. Unlocking autonomous mode."),this.clearAutonomousCooldown(),this.startAutoScroll())}updatePassiveGatheringEnabled(e){this.isPassiveGatheringEnabled!==e&&(i(`[ContentScript] Capture Enabled state changing to: ${e}`),this.isPassiveGatheringEnabled=e,this.isConnected&&(this.isPassiveGatheringEnabled?this.startProcesses():this.stopProcesses({autoScroll:!0})))}startGatherHealthCheck(){this.gatherHealthCheckInterval!==void 0&&clearInterval(this.gatherHealthCheckInterval),this.gatherHealthCheckInterval=window.setInterval(()=>{this.checkGatherHealth()},this.GATHER_HEALTH_CHECK_INTERVAL)}stopGatherHealthCheck(){this.gatherHealthCheckInterval!==void 0&&(clearInterval(this.gatherHealthCheckInterval),this.gatherHealthCheckInterval=void 0)}checkGatherHealth(){chrome.runtime.sendMessage({type:"GET_HEALTH_CHECK_INFO"},e=>{if(chrome.runtime.lastError){m("[DynamicContentScript] Error getting health check info:",chrome.runtime.lastError);return}if(!e){i("[DynamicContentScript] No response from background script");return}const{isManuallyDisconnected:t,hasPlatformTab:s}=e;if(console.log("isManuallyDisconnected",t),console.log("hasPlatformTab",s),t)return;if(!s){i("[DynamicContentScript] No platform tabs found, skipping health check");return}if(!this.isConnected){i("[DynamicContentScript] Connection lost but not manually disconnected."),this.stopAutoScroll(),this.verifyAndRecoverConnection();return}if(!this.isGatheringEnabled){i("[DynamicContentScript] Gathering disabled but not manually disconnected. Attempting to re-enable..."),this.enableGathering();return}const n=Date.now(),a=n-this.lastSuccessfulGather;if(this.isAutoscrollEnabled)a>this.MAX_GATHER_INACTIVITY_AUTONOMOUS&&this.attemptRecovery("autonomous",a);else{const l=n-this.lastScrollTime;l<this.SCROLL_ACTIVITY_THRESHOLD?a>this.MAX_GATHER_INACTIVITY_OBSERVER?(this.consecutiveFailedAttempts++,i(`[DynamicContentScript] User is actively scrolling (last scroll ${l}ms ago) but no data gathered for ${a}ms. Failed attempt ${this.consecutiveFailedAttempts}/${this.MAX_CONSECUTIVE_FAILURES}`),this.consecutiveFailedAttempts>=this.MAX_CONSECUTIVE_FAILURES?(i(`[DynamicContentScript] Reached ${this.MAX_CONSECUTIVE_FAILURES} consecutive failed attempts, attempting recovery...`),this.attemptRecovery("observer",a),this.consecutiveFailedAttempts=0):(i("[DynamicContentScript] Attempting soft recovery..."),this.attemptSoftRecovery())):this.consecutiveFailedAttempts=0:(this.consecutiveFailedAttempts=0,i(`[DynamicContentScript] No recent scroll activity (${l}ms), skipping health check in observer mode`))}})}attemptSoftRecovery(){this.observer&&(this.observer.disconnect(),this.observer=null),this.initializeObserver(),this.debouncedProcessFeed()}attemptRecovery(e,t){i(`[DynamicContentScript] No successful gathering for ${t}ms in ${e} mode. Attempting recovery...`),this.observer&&(this.observer.disconnect(),this.observer=null),this.initializeObserver(),this.debouncedProcessFeed(),this.recoveryTimeout!==void 0&&clearTimeout(this.recoveryTimeout),this.recoveryTimeout=window.setTimeout(()=>{Date.now()-this.lastSuccessfulGather>this.MAX_GATHER_INACTIVITY_AUTONOMOUS&&e==="autonomous"&&(i("[DynamicContentScript] Recovery failed, refreshing page..."),this.isAutoscrollEnabled&&window.location.reload()),this.recoveryTimeout=void 0},5e3)}async verifyAndRecoverConnection(){try{const e=await k(),t=await chrome.runtime.sendMessage({type:"PING"});e.isConnected&&t?(i("[DynamicContentScript] Connection verified, recovering..."),this.isConnected=!0,this.initialize()):i("[DynamicContentScript] Connection still down, staying stopped")}catch(e){i("[DynamicContentScript] Connection verification failed:",e)}}}function at(o){i("Initializing content script with config:",o);const r=new ot(o),e=(s,n)=>{if(n==="local"&&(s.isConnected&&(r.isConnected=!!s.isConnected.newValue),s.autoScrollEnabled)){i("[Storage] Auto-scroll state changing:",{oldValue:s.autoScrollEnabled.oldValue,newValue:s.autoScrollEnabled.newValue}),r.isAutoscrollEnabled=s.autoScrollEnabled.newValue;const a=r.isConnected&&s.autoScrollEnabled.newValue;i("[Storage] Auto-scroll conditions:",{isConnected:r.isConnected,autoScrollEnabled:s.autoScrollEnabled.newValue,shouldStart:a}),a?(i("[Storage] Starting auto-scroll"),r.startAutoScroll()):(i("[Storage] Stopping auto-scroll"),r.stopAutoScroll())}};chrome.storage.onChanged.addListener(e),window.addEventListener("scroll",r.handleScroll,{passive:!0});const t=()=>{i("[ContentScript] Cleaning up..."),r.stopAutoScroll(),window.removeEventListener("scroll",r.handleScroll),chrome.storage.onChanged.removeListener(e),r.cleanup(),delete window._contentScript};return window._contentScript={cleanup:t},r.isConnected&&requestIdleCallback(()=>r.processFeed(),{timeout:2e3}),t}const lt={matches:["https://*.x.com/*","https://*.twitter.com/*","https://dashboard.teneo.pro/*"],main(){i("[ContentScript] Main function executed.");let o=!1,r=null;const e=(t,s,n)=>{if(i("[ContentScript] Received message:",t.type),t.type==="INIT_DYNAMIC_CONTENT_SCRIPT"&&t.config){if(o)return i("[ContentScript] Already initialized for this page."),n({success:!0,message:"Already initialized"}),!0;try{i("[ContentScript] Initializing with config:",t.config.platform.id),r=at(t.config),o=!0,i("[ContentScript] Initialization completed successfully."),n({success:!0})}catch(a){m("[ContentScript] Initialization failed:",a),n({success:!1,error:String(a)})}return!0}if(t.type===B.SYNC_GATHERED_DATA){try{const a=localStorage.getItem("gatheredData"),l=JSON.stringify(t.data);a!==l?(localStorage.setItem("gatheredData",l),i("[ContentScript] Successfully stored gathered data in website localStorage")):i("[ContentScript] Gathered data is the same, no need to update localStorage"),n({success:!0})}catch(a){m("[ContentScript] Failed to store gathered data:",a),n({success:!1,error:String(a)})}return!0}if(t.type===B.SYNC_FULL_CONFIG){try{const a=localStorage.getItem("fullConfig"),l=JSON.stringify(t.data);a!==l?(localStorage.setItem("fullConfig",l),i("[ContentScript] Successfully stored full config in website localStorage")):i("[ContentScript] Full config is the same, no need to update localStorage"),n({success:!0})}catch(a){m("[ContentScript] Failed to store full config:",a),n({success:!1,error:String(a)})}return!0}return t.type==="STOP_CONTENT_SCRIPT"?(r?(i("[ContentScript] Received stop command. Cleaning up."),r(),r=null,o=!1,n({success:!0})):(i("[ContentScript] Received stop command, but not initialized."),n({success:!1,error:"Not initialized"})),!0):!1};chrome.runtime.onMessage.addListener(e),chrome.runtime.sendMessage({type:"CONTENT_SCRIPT_READY",url:window.location.href}).then(()=>i("[ContentScript] CONTENT_SCRIPT_READY message sent to background.")).catch(t=>m("[ContentScript] Failed to send CONTENT_SCRIPT_READY message:",t)),window.addEventListener("message",t=>{if(!["https://dashboard.teneo.pro"].includes(t.origin))return;const{action:n}=t.data||{};n==="clearExtensionStorage"&&(i("[ContentScript] Received clearExtensionStorage message"),chrome.runtime.sendMessage({action:"clearExtensionStorage"},a=>{window.postMessage({action:"clearExtensionStorageResponse",...a},t.origin)}))})}},O=((X=(j=globalThis.browser)==null?void 0:j.runtime)==null?void 0:X.id)==null?globalThis.chrome:globalThis.browser;function R(o,...r){}const ct={debug:(...o)=>R(console.debug,...o),log:(...o)=>R(console.log,...o),warn:(...o)=>R(console.warn,...o),error:(...o)=>R(console.error,...o)},$=class $ extends Event{constructor(r,e){super($.EVENT_NAME,{}),this.newUrl=r,this.oldUrl=e}};u($,"EVENT_NAME",H("wxt:locationchange"));let L=$;function H(o){var r;return`${(r=O==null?void 0:O.runtime)==null?void 0:r.id}:gather:${o}`}function ut(o){let r,e;return{run(){r==null&&(e=new URL(location.href),r=o.setInterval(()=>{let t=new URL(location.href);t.href!==e.href&&(window.dispatchEvent(new L(t,e)),e=t)},1e3))}}}const P=class P{constructor(r,e){u(this,"isTopFrame",window.self===window.top);u(this,"abortController");u(this,"locationWatcher",ut(this));u(this,"receivedMessageIds",new Set);this.contentScriptName=r,this.options=e,this.abortController=new AbortController,this.isTopFrame?(this.listenForNewerScripts({ignoreFirstEvent:!0}),this.stopOldScripts()):this.listenForNewerScripts()}get signal(){return this.abortController.signal}abort(r){return this.abortController.abort(r)}get isInvalid(){return O.runtime.id==null&&this.notifyInvalidated(),this.signal.aborted}get isValid(){return!this.isInvalid}onInvalidated(r){return this.signal.addEventListener("abort",r),()=>this.signal.removeEventListener("abort",r)}block(){return new Promise(()=>{})}setInterval(r,e){const t=setInterval(()=>{this.isValid&&r()},e);return this.onInvalidated(()=>clearInterval(t)),t}setTimeout(r,e){const t=setTimeout(()=>{this.isValid&&r()},e);return this.onInvalidated(()=>clearTimeout(t)),t}requestAnimationFrame(r){const e=requestAnimationFrame((...t)=>{this.isValid&&r(...t)});return this.onInvalidated(()=>cancelAnimationFrame(e)),e}requestIdleCallback(r,e){const t=requestIdleCallback((...s)=>{this.signal.aborted||r(...s)},e);return this.onInvalidated(()=>cancelIdleCallback(t)),t}addEventListener(r,e,t,s){var n;e==="wxt:locationchange"&&this.isValid&&this.locationWatcher.run(),(n=r.addEventListener)==null||n.call(r,e.startsWith("wxt:")?H(e):e,t,{...s,signal:this.signal})}notifyInvalidated(){this.abort("Content script context invalidated"),ct.debug(`Content script "${this.contentScriptName}" context invalidated`)}stopOldScripts(){window.postMessage({type:P.SCRIPT_STARTED_MESSAGE_TYPE,contentScriptName:this.contentScriptName,messageId:Math.random().toString(36).slice(2)},"*")}verifyScriptStartedEvent(r){var n,a,l;const e=((n=r.data)==null?void 0:n.type)===P.SCRIPT_STARTED_MESSAGE_TYPE,t=((a=r.data)==null?void 0:a.contentScriptName)===this.contentScriptName,s=!this.receivedMessageIds.has((l=r.data)==null?void 0:l.messageId);return e&&t&&s}listenForNewerScripts(r){let e=!0;const t=s=>{if(this.verifyScriptStartedEvent(s)){this.receivedMessageIds.add(s.data.messageId);const n=e;if(e=!1,n&&(r!=null&&r.ignoreFirstEvent))return;this.notifyInvalidated()}};addEventListener("message",t),this.onInvalidated(()=>removeEventListener("message",t))}};u(P,"SCRIPT_STARTED_MESSAGE_TYPE",H("wxt:content-script-started"));let F=P;const dt=Symbol("null");let ht=0;class mt extends Map{constructor(){super(),this._objectHashes=new WeakMap,this._symbolHashes=new Map,this._publicKeys=new Map;const[r]=arguments;if(r!=null){if(typeof r[Symbol.iterator]!="function")throw new TypeError(typeof r+" is not iterable (cannot read property Symbol(Symbol.iterator))");for(const[e,t]of r)this.set(e,t)}}_getPublicKeys(r,e=!1){if(!Array.isArray(r))throw new TypeError("The keys parameter must be an array");const t=this._getPrivateKey(r,e);let s;return t&&this._publicKeys.has(t)?s=this._publicKeys.get(t):e&&(s=[...r],this._publicKeys.set(t,s)),{privateKey:t,publicKey:s}}_getPrivateKey(r,e=!1){const t=[];for(let s of r){s===null&&(s=dt);const n=typeof s=="object"||typeof s=="function"?"_objectHashes":typeof s=="symbol"?"_symbolHashes":!1;if(!n)t.push(s);else if(this[n].has(s))t.push(this[n].get(s));else if(e){const a=`@@mkm-ref-${ht++}@@`;this[n].set(s,a),t.push(a)}else return!1}return JSON.stringify(t)}set(r,e){const{publicKey:t}=this._getPublicKeys(r,!0);return super.set(t,e)}get(r){const{publicKey:e}=this._getPublicKeys(r);return super.get(e)}has(r){const{publicKey:e}=this._getPublicKeys(r);return super.has(e)}delete(r){const{publicKey:e,privateKey:t}=this._getPublicKeys(r);return!!(e&&super.delete(e)&&this._publicKeys.delete(t))}clear(){super.clear(),this._symbolHashes.clear(),this._publicKeys.clear()}get[Symbol.toStringTag](){return"ManyKeysMap"}get size(){return super.size}}new mt;function bt(){}function U(o,...r){}const pt={debug:(...o)=>U(console.debug,...o),log:(...o)=>U(console.log,...o),warn:(...o)=>U(console.warn,...o),error:(...o)=>U(console.error,...o)};return(async()=>{try{const{main:o,...r}=lt,e=new F("gather",r);return await o(e)}catch(o){throw pt.error('The content script "gather" crashed on startup!',o),o}})()}();
gather;
